import 'package:flutter/material.dart';
import 'package:test_app/core/constants/routes_constants.dart';
import 'package:test_app/core/utils/responsive_extention.dart';
import 'package:test_app/features/app/presentation/controller/controllers/adhkar_page_controller.dart';
import 'package:test_app/features/app/presentation/controller/controllers/get_adhkar_controller.dart';
import 'package:test_app/features/app/presentation/view/components/adhkar_widget.dart';
import 'package:test_app/features/app/presentation/view/components/adhkar_page_app_bar.dart';
import 'package:test_app/features/app/presentation/view/components/common_circle_layout.dart';

class AdhkarPage extends StatefulWidget {
  final String nameOfAdhkar;
  final GetAdhkarController getAdhkarController;

  const AdhkarPage({
    super.key,
    required this.nameOfAdhkar,
    required this.getAdhkarController,
  });

  @override
  State<AdhkarPage> createState() => _AdhkarPageState();
}

class _AdhkarPageState extends State<AdhkarPage> {
  late final AdhkarPageController adhkarPageController;
  OverlayEntry? _overlayEntry;

  @override
  void initState() {
    super.initState();
    adhkarPageController = AdhkarPageController();
    adhkarPageController.initState(context);

    // WidgetsBinding.instance.addPostFrameCallback((_) {
    //   _insertOverlay();
    // });
  }

  // ignore: unused_element
  void _insertOverlay() {
    // ูุชุฃูุฏ ุฅู ุงูู OverlayEntry ูุด ูุถุงู ูุจู ูุฏู ุนุดุงู ูุง ูุชูุฑุฑุด
    if (_overlayEntry != null) return;

    _overlayEntry = OverlayEntry(
      builder: (context) => Positioned(
        bottom: 16,
        left: 16,
        child: Material(
          color: Colors.transparent,
          child: ListenableBuilder(
            listenable: adhkarPageController.progressNotfier,
            builder: (_, __) => Offstage(
              // Offstage: ุนุดุงู ููุฏุฑ ูุฎูู ุงูุฏุงูุฑุฉ ุจุฏูู ูุง ูุดูููุง ูู ุงูุดุฌุฑุฉุ
              // ูุจุงูุชุงูู ูุญุงูุธ ุนูู ุญุงูุชูุง ููููุน ุฅุนุงุฏุฉ ุจูุงุก ูุงูู.
              offstage: !adhkarPageController.isCircleSliderShowed,
              child: CommonCircleLayout(
                  customPaintSize: context.width * 0.10,
                  lineSize: 8.0,
                  maxProgress: adhkarPageController.maxProgress,
                  progressNotifier: adhkarPageController.progressNotfier),
            ),
          ),
        ),
      ),
    );
    // ุฅุฏุฎุงู ุงูู OverlayEntry ูู ุงูู Overlay ุงูุฑุฆูุณู
    Overlay.of(context).insert(_overlayEntry!);
  }

  @override
  void dispose() {
    _overlayEntry?.remove();
    adhkarPageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async {
        Navigator.pushReplacementNamed(
          context,
          RoutesConstants.homePageRouteName,
        );
        return false;
      },
      child: Scaffold(
        appBar: AdhkarPageAppBar(
          appBarTitle: widget.nameOfAdhkar,
          adhkarPageController: adhkarPageController,
        ),
        body: AnimatedList(
          // ููุงุญุธุฉ ูููุฉ ุญูู ุงูุฃุฏุงุก:
//
// ูู Flutter ููู ูุฑู ุจูู "ุฅุนุงุฏุฉ ุงูุจูุงุก" (Rebuild) ู "ุฅุนุงุฏุฉ ุงูุฑุณู" (Repaint):
//
// - ุฅุนุงุฏุฉ ุงูุจูุงุก (Rebuild):
//   ุจุชุญุตู ููุง Flutter ูุนูุฏ ุงุณุชุฏุนุงุก build() ูููุฏุฌุงุช.
//   ุฏู ุจูุญุตู ูุซูุงู ูุน setState ุฃู ValueNotifier.
//   ุงูุนูููุฉ ุฏู ุฎูููุฉ ูุณุจููุง ูุฃููุง ุจุชุชุนุงูู ูุน Widgets (ูุตู ููุดูู)
//   ูุด ูุน ุงูุฑุณู ุงููุนูู ุนูู ุงูุดุงุดุฉ.
//
// - ุฅุนุงุฏุฉ ุงูุฑุณู (Repaint):
//   ุจุชุญุตู ููุง RenderObject ูุญุชุงุฌ ูุฑุณู ููุณู ูู ุฌุฏูุฏ ุนูู ุงูู Canvas.
//   ุฒู ูุซูุงู CustomPainter ุจูุฑุณู ุฏุงุฆุฑุฉ ุฃู ProgressIndicator ุจูุญุฏุซ ูููุชู.
//   ุงูุนูููุฉ ุฏู ุฃุซูู ูู ุงูู Rebuild ูุฃููุง ุจุชุชุนุงูู ูุน ุงูุจูุณูุงุช ูุจุงุดุฑุฉ.
//
// ูู ุญุงูุชูุง:
// - AnimatedList ูููู ุชุนูู Rebuild ุฃุซูุงุก ุงูุงุณูุฑูู (ุนุงุฏู ููุด ูููู ููู).
// - ููู CommonCircleLayout (ุงููู ุจูุฑุณู ุฏุงุฆุฑุฉ ูุฎุตุตุฉ) ุจูุนูู Repaint
//   ูุชูุฑ ุฌุฏูุง ูุน ูู ุชุญุฏูุซ ููู progress.
//   ุนุดุงู ูุฏู ููููุงู ุจู RepaintBoundary => [ููุฌูุฏ ูู CommonCircleLayout ุนุดุงู ุงู ููุงู ูู ุงููุดุฑูุน ูุณุชุฎุฏู ุงูููุงุณ ุฏูู]:
//   ุฏู ุจูุนุฒู ุงููุฏุฌุช ุจุญูุซ ุฅุนุงุฏุฉ ุงูุฑุณู ุจุชุงุนุชู ูุง ุชุฌุจุฑุด ุจุงูู ุงูุดุงุดุฉ ุชุชุนุงุฏ ุฑุณููุง.
//
// ุงููุชูุฌุฉ:
// - Flutter ููุนูุฏ ุฑุณู ุงูุฌุฒุก ุงูุฎุงุต ุจุงูุฏุงูุฑุฉ ุจุณ.
// - ุฏู ูููู ุงูุญูู ุนูู ุงูู GPU ููุฎูู ุงูุงุณูุฑูู ูุงูุฃููููุดู ุฃุณูุณ.

//   ===ุงูุชู ุงุญุท RepaintBoundary===

/*
Checklist: ุฃุญุท RepaintBoundary ููุงุ

ูู ุงูููุฏุฌุช ูููุง ุฑุณู ูุฎุตุต (CustomPaint / ShaderMask / ClipPath / ImageFilter)ุ

ูุนู โ ุบุงูุจูุง ูุญุชุงุฌ RepaintBoundary.

ูุง โ ุฑูุญ ููุณุคุงู ุงููู ุจุนุฏู.

ูู ุงูููุฏุฌุช ุจุชุชุบูุฑ ุฃู ุชุชุฃูููุช ูู ูุฑูู (ุฒู progress ุฃู slider ุดุบุงู ุจุงุณุชูุฑุงุฑ)ุ

ูุนู โ ุญุท RepaintBoundary ุญูุงููู ุงูุฌุฒุก ุฏู ููุทุ ุนุดุงู ูุง ูุฌุฑุด ุจุงูู ุงูุดุงุดุฉ ูู ุงูู repaint.

ูุง โ ูุด ุถุฑูุฑู.

ูู ุงูููุฏุฌุช ูุจูุฑุฉ ุฃู ูููุง ูุญุชูู ุซุงุจุช (ุฒู ุตูุฑุฉ ูุจูุฑุฉ ุฃู ุฑุณู ุชููู)ุ

ูุนู โ RepaintBoundary ููุณุงุนุฏ ูุญุงูุธ ุนูู ุงููุงุด.

ูุง โ ุบุงูุจูุง ูุด ููู.

ูู ูุงุญุธุช ูู ุงูู performance overlay ุฅู ุงูู repaint area ุฃูุจุฑ ูู ุงููุงุฒูุ

ูุนู โ ุงุนุฒู ุงูุฌุฒุก ุงููุชุบูุฑ ุจุฑูุจููุช.

ูุง โ ุณูุจูุง ุฒู ูุง ูู.

ูู ููู ุฃุฌุฒุงุก UI ูุด ูุฑุชุจุทุฉ ุจุจุนุถุ (ูุซูุงู ุฃููุฑูุงู/ุจุงุฏุฌ/ุฏุงุฆุฑุฉ ุชูุฏู)

ูุนู โ ุงุนุฒููู ุจุฑูุจููุช.

ูุง โ ูุด ูุงุฒู.
*/

//   ===ููุญูุธุงุช===

/*
1. ูุนูู ุฅูู RepaintBoundary ุฃุตูุงูุ

ูู ุฒู "ุนุงุฒู" ุจูููู ูู Flutter: "ุงุฑุณู ุงูุฌุฒุก ุฏู ูุฑุฉ ูุงุญุฏุฉุ ููู ุจุงูู ุงูุตูุญุฉ ุงุชุนูููุง Rebuildุ ูุชุนูุฏุด ุฑุณูู ุฅูุง ูู ูู ููุณู ุงุชุบูุฑ".

ุงููุชูุฌุฉ โ ุชููุน ุฃู ุฅุนุงุฏุฉ ุฑุณู ุฒุงุฆุฏุฉ ุญูุงููู ุงูู widget.

2. ุงูุญุงูุฉ ุงูุนุงุฏูุฉ (Widget ูุด ุจูุชุบูุฑ ูุชูุฑ)

ูุซูุงู ุนูุฏู ุตูุฑุฉ (Image) ุซุงุจุชุฉ ุฌูุง ListView:

ูู ุบูุฑ RepaintBoundary โ ูู ูุง ูุชุนูู scrollุ Flutter ูููู ูุถุทุฑ ูุฑุณู ุงูุตูุฑุฉ ุชุงูู ูุน ุจุงูู ุงูุนูุงุตุฑ.

ูุน RepaintBoundary โ Flutter ูููุงุด ุงูุตูุฑุฉุ ููุด ููุฑุณููุง ุชุงูู ุฅูุง ูู ุงูุตูุฑุฉ ููุณูุง ุงุชุบูุฑุช.

ุฏู ููุณุจ ุฃุฏุงุก ูุจูุฑ.

3. ุงูุญุงูุฉ ุงููู ุจุชุชููู ุนููุง (Widget ุจูุชุบูุฑ ูู ูุฑูู)

ุฒู Progress Circle ูุนููู ุจู CustomPaint ุฃู Animation:

ุฏู ุจูุชุบูุฑ ูู ูู ูุฑูู (60 ูุฑุฉ ูู ุงูุซุงููุฉ).

ุจุงูุชุงูู Flutter ูุงุฒู ูุฑุณูู ูู ุงูุฃูู ูู ูุฑูู โ ููุง RepaintBoundary ูุด ููููู ุดุบู ุงูุฑุณู ุฌูุง ุงูุฏุงูุฑุฉ ููุณูุง.

ููู! ูู ูููุด RepaintBoundary โ Flutter ูููู ูุนูุฏ ุฑุณู ุญุงุฌุงุช ุชุงููุฉ ุฌูุจู ุฃู ูููู ุฃู ุชุญุชู (ูุฃูู ูุด ูุนุฒูู).

ูุน RepaintBoundary โ ุงูุช ุถููุช ุฅู ุงูุชุฃุซูุฑ ุงูุชููู ูุชุนุฒูุ ูุจุงูู ุงูุตูุญุฉ ูุด ููุชุฃุซุฑ.

4. ุงูุฎูุงุตุฉ

ูู ุงูุฑุณู ุซุงุจุช โ RepaintBoundary = ููุณุจ ูุจูุฑ.

ูู ุงูุฑุณู ูุชุบูุฑ ุจุงุณุชูุฑุงุฑ โ ุงูููุณุจ ุงูุฃุณุงุณู ุฅูู ุจุชุญูู ุจุงูู ุงูู UI ูู ุฅุนุงุฏุฉ ุงูุฑุณู ูุนุงูุ ูุด ุฅู ุงูุฏุงูุฑุฉ ููุณูุง ูุชุจูู ุฃุณุฑุน.

5. ุงูุญุงุฌุงุช ุฏู ุจุงูุฐุงุช ( CustomPaint / ShaderMask / ClipPath / ImageFilter ) ุชุนุชุจุฑ high-cost widgets ูุฃููุง ุจุชุฌุจุฑ Flutter ูุฑุณู pixels ูู ุงูุฃูู ุจุฏู ูุง ูุนูุฏ ุงุณุชุฎุฏุงู ุงูุฑุณู ุงููู ูู ุงููุงุด.

6. Rebuild = ููุง ุงูุจูุงูุงุช ุฃู State ุชุชุบูุฑ โ Flutter ูุจูู ุดุฌุฑุฉ Widgets ุฌุฏูุฏุฉ.

Repaint = ููุง ุงูุดูู ุงููุฑุฆู ูุงุฒู ูุชุนุงุฏ ุฑุณูู (Canvas) ุฒู ุชุบููุฑุงุช ูู ุตูุงุช ูููุชููุฑ.
*/

//   ===ุณูุงู ููู===

/*
ุทุจ ููู ูุซูุง ูู ุนุงูููู ุงูููุดู ูุจูุนููุด ุฑูุจูู 
ChatGPT said:

ุณุคุงู ููุชุงุฒ ๐
ุฎูููู ุฃูุฑููู ุจูู Animation ูุจูู RepaintBoundary ุนุดุงู ุงูุตูุฑุฉ ุชุจูู ุฃูุถุญ:

1. ุงูุฃููููุดู ูู Flutter

ูุด ูู Animation = Repaint.

ูู Flutter ุนูุฏูุง ููุนูู:

Property animations (ุฒู Opacity, Transform.scale, Positioned, Alignโฆ ุฅูุฎ): ุฏู ุจุชุณุชุฎุฏู GPU ูุจุชุชุทุจู ูู layer transformุ ููุจุชุญุชุงุฌุด Repaint ุฃุตูุงู. ูุนูู ุงูุตูุฑุฉ ุฃู ุงููุฏุฌุช ูุด ุจูุชุนุงุฏ ุฑุณููุ ุจูุชุงุฎุฏ ุฒู ูุง ูู ููุชุญุฑู/ูุชุบูุฑ ุญุฌูู/ูุชููุจ ุจุงูู GPU โ ุณุฑูุน ุฌุฏูุง.

Custom animations (ุฒู ุงููู ูุนููู ุจู CustomPainter ุฃู ShaderMask ุฃู ImageFilter): ุฏู ุจุชุชุทูุจ ุฅุนุงุฏุฉ ุฑุณู ูู ูุฑูู ูุฃู ูุญุชูู ุงูู pixels ููุณู ุจูุชุบูุฑ.

2. RepaintBoundary

ูุธููุชู ุฅูู ูููู:
"ููุง ุชุนูู ุฅุนุงุฏุฉ ุฑุณู ููู widget ุฏูุ ูุชุฃุซุฑุด ุนูู ุงูุจุงูู".

ูุด ูุนูุงู ูููุน ุงูู repaint ููุณู.

ูุนูู ูู ุนูุฏู Progress Circle ูุนููู ุจู CustomPainter โ ุฏู ูุงุฒู ูุชุนุงุฏ ุฑุณูู ูู frame (ูุฃู ุงูุฎุทูุท ููุณูุง ุจุชุชุบูุฑ). ุจุณ RepaintBoundary ุจูุฎูู ุงูุชุฃุซูุฑ confined ุฌูุงู.

3. ููู ูุด ุจูุญุท RepaintBoundary ุญูุงููู ูู Animationุ

ูู ุงูุฃููููุดู ุจูุชุนูู ุจุงูู GPU (Transform, Opacity, Positionโฆ) โ ูููุงุด ูุงุฒูุฉ ูุฃู ูููุด repaint ุฃุตูุงูุ ูุฌุฑุฏ ุญุฑูุฉ Layer.

ูู ุงูุฃููููุดู ุจูุบูุฑ Pixels (ุฒู CustomPaint) โ RepaintBoundary ูููุฏ ุนุดุงู ูููุน ุจุงูู ุงูู UI ูู ุฅุนุงุฏุฉ ุงูุฑุณู.

โ ุงูุฎูุงุตุฉ:

Animations ุงููุนุชูุฏุฉ ุนูู Layers (GPU) โ ูุด ูุญุชุงุฌุฉ RepaintBoundary.

Animations ุงููุนุชูุฏุฉ ุนูู ุฑุณูุฉ ุฌุฏูุฏุฉ ูู Frame โ ููุถู ุชุชุญุท ุฌูุง RepaintBoundary.
*/
          padding: const EdgeInsets.all(8.0),
          key: adhkarPageController.animatedLIstKey,
          controller: adhkarPageController.adhkarScrollController,
          initialItemCount: widget.getAdhkarController.adhkar.length,
          itemBuilder: (context, index, animation) => AdhkarWidget(
            adhkarPageController: adhkarPageController,
            index: index,
            adhkarEntity: widget.getAdhkarController.adhkar.elementAt(index),
          ),
        ),
      ),
    );
  }
}
